from telegram import Update, ReplyKeyboardMarkup
from telegram.ext import ContextTypes
from telegram.error import TelegramError
import os
from telegram.helpers import escape_markdown
from bot_responses import (
    CONSULTATION_PROMPT, GENDER_THERAPY_MESSAGE, MASCULINIZING_HRT_INFO, FEMINIZING_HRT_INFO,
    DIY_HRT_WARNING, F64_MESSAGE, SURGERY_INFO_MESSAGE, FTM_SURGERY_INFO, MTF_SURGERY_INFO
)
from keyboards import MEDICAL_MENU_BUTTONS, GENDER_THERAPY_CHOICE_BUTTONS, SURGERY_INFO_KEYBOARD, BACK_BUTTON, HELP_MENU_BUTTONS
from utils.constants import BotState, REQUEST_TYPES
from utils.message_utils import check_rate_limit
import logging

logger = logging.getLogger(__name__)

async def medical_menu(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    if not await check_rate_limit(update, context):
        return BotState.MEDICAL_MENU
    choice = update.message.text
    if choice == BACK_BUTTON:
        keyboard = HELP_MENU_BUTTONS
        await update.message.reply_text(
            escape_markdown("–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –ø–æ–º–æ—â–∏:", version=2),
            reply_markup=keyboard,
            parse_mode="MarkdownV2"
        )
        return BotState.HELP_MENU
    elif choice == "ü©∫ –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è –ø–æ–º–æ—â—å":
        keyboard = ReplyKeyboardMarkup(MEDICAL_MENU_BUTTONS + [[BACK_BUTTON]], resize_keyboard=True)
        await update.message.reply_text(
            escape_markdown("–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–π –ø–æ–º–æ—â–∏:", version=2),
            reply_markup=keyboard,
            parse_mode="MarkdownV2"
        )
        return BotState.MEDICAL_MENU
    elif choice == "üó£Ô∏è –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è":
        keyboard = ReplyKeyboardMarkup([[BACK_BUTTON]], resize_keyboard=True)
        await update.message.reply_text(
            CONSULTATION_PROMPT,
            reply_markup=keyboard,
            parse_mode="MarkdownV2"
        )
        context.user_data["request_type"] = REQUEST_TYPES["medical_consult"]
        return BotState.TYPING
    elif choice == "üíâHRT":
        keyboard = ReplyKeyboardMarkup(
            GENDER_THERAPY_CHOICE_BUTTONS + [[BACK_BUTTON]], resize_keyboard=True
        )
        await update.message.reply_text(
            GENDER_THERAPY_MESSAGE,
            parse_mode="MarkdownV2",  # –ú–µ–Ω—è–µ–º –Ω–∞ MarkdownV2
            reply_markup=keyboard
        )
        return BotState.MEDICAL_GENDER_THERAPY_MENU
    elif choice == "‚ùì F64":
        keyboard = ReplyKeyboardMarkup([[BACK_BUTTON]], resize_keyboard=True)
        await update.message.reply_text(
            F64_MESSAGE,
            parse_mode="MarkdownV2",  # –ú–µ–Ω—è–µ–º –Ω–∞ MarkdownV2
            reply_markup=keyboard
        )
        return BotState.MEDICAL_MENU
    elif choice == "‚öïÔ∏è –û–ø–µ—Ä–∞—Ü–∏–∏":
        await update.message.reply_text(
            SURGERY_INFO_MESSAGE,
            parse_mode="MarkdownV2",  # –ú–µ–Ω—è–µ–º –Ω–∞ MarkdownV2
            reply_markup=SURGERY_INFO_KEYBOARD
        )
        return BotState.MEDICAL_SURGERY_PLANNING
    await update.message.reply_text(
        escape_markdown("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –æ–ø—Ü–∏—é –∏–∑ –º–µ–Ω—é.", version=2),
        parse_mode="MarkdownV2"
    )
    return BotState.MEDICAL_MENU

async def medical_gender_therapy_menu(
    update: Update, context: ContextTypes.DEFAULT_TYPE
) -> int:
    if not await check_rate_limit(update, context):
        return BotState.MEDICAL_GENDER_THERAPY_MENU
    choice = update.message.text
    if choice == BACK_BUTTON:
        return await medical_menu(update, context)
    elif choice == "T":
        keyboard = ReplyKeyboardMarkup(
            [["DIY"], ["–ó–∞–ø—Ä–æ—Å–∏—Ç—å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é –ø–æ –º—É–∂—Å–∫–æ–π –ì–¢"], [BACK_BUTTON]],
            resize_keyboard=True,
        )
        await update.message.reply_text(
            MASCULINIZING_HRT_INFO,
            parse_mode="MarkdownV2",  # –ú–µ–Ω—è–µ–º –Ω–∞ MarkdownV2
            reply_markup=keyboard
        )
        return BotState.MEDICAL_FTM_HRT
    elif choice == "E":
        keyboard = ReplyKeyboardMarkup(
            [["DIY"], ["–ó–∞–ø—Ä–æ—Å–∏—Ç—å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é –ø–æ –∂–µ–Ω—Å–∫–æ–π –ì–¢"], [BACK_BUTTON]],
            resize_keyboard=True,
        )
        await update.message.reply_text(
            FEMINIZING_HRT_INFO,
            parse_mode="MarkdownV2",  # –ú–µ–Ω—è–µ–º –Ω–∞ MarkdownV2
            reply_markup=keyboard
        )
        return BotState.MEDICAL_MTF_HRT
    await update.message.reply_text(
        escape_markdown("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –æ–ø—Ü–∏—é –∏–∑ –º–µ–Ω—é.", version=2),
        parse_mode="MarkdownV2"
    )
    return BotState.MEDICAL_GENDER_THERAPY_MENU

async def medical_ftm_hrt(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    if not await check_rate_limit(update, context):
        return BotState.MEDICAL_FTM_HRT
    choice = update.message.text
    if choice == BACK_BUTTON:
        return await medical_gender_therapy_menu(update, context)
    elif choice == "DIY":
        keyboard = ReplyKeyboardMarkup(
            [["–Ø –ø–æ–Ω–∏–º–∞—é —Ä–∏—Å–∫–∏, —Å–∫–∞—á–∞—Ç—å –≥–∞–π–¥"], [BACK_BUTTON]], resize_keyboard=True
        )
        await update.message.reply_text(
            DIY_HRT_WARNING,
            parse_mode="MarkdownV2",  # –ú–µ–Ω—è–µ–º –Ω–∞ MarkdownV2
            reply_markup=keyboard
        )
        return BotState.MEDICAL_FTM_HRT
    elif choice == "–ó–∞–ø—Ä–æ—Å–∏—Ç—å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é –ø–æ –º—É–∂—Å–∫–æ–π –ì–¢":
        keyboard = ReplyKeyboardMarkup([[BACK_BUTTON]], resize_keyboard=True)
        await update.message.reply_text(
            CONSULTATION_PROMPT,
            parse_mode="MarkdownV2",  # –ú–µ–Ω—è–µ–º –Ω–∞ MarkdownV2
            reply_markup=keyboard
        )
        context.user_data["request_type"] = REQUEST_TYPES["ftm_hrt"]
        return BotState.TYPING
    elif choice == "–Ø –ø–æ–Ω–∏–º–∞—é —Ä–∏—Å–∫–∏, —Å–∫–∞—á–∞—Ç—å –≥–∞–π–¥":
        return await send_hrt_guide(update, context, "ftm")
    await update.message.reply_text(
        escape_markdown("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –æ–ø—Ü–∏—é –∏–∑ –º–µ–Ω—é.", version=2),
        parse_mode="MarkdownV2"
    )
    return BotState.MEDICAL_FTM_HRT

async def medical_mtf_hrt(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    if not await check_rate_limit(update, context):
        return BotState.MEDICAL_MTF_HRT
    choice = update.message.text
    if choice == BACK_BUTTON:
        return await medical_gender_therapy_menu(update, context)
    elif choice == "DIY":
        keyboard = ReplyKeyboardMarkup(
            [["–Ø –ø–æ–Ω–∏–º–∞—é —Ä–∏—Å–∫–∏, —Å–∫–∞—á–∞—Ç—å –≥–∞–π–¥"], [BACK_BUTTON]], resize_keyboard=True
        )
        await update.message.reply_text(
            DIY_HRT_WARNING,
            parse_mode="MarkdownV2",  # –ú–µ–Ω—è–µ–º –Ω–∞ MarkdownV2
            reply_markup=keyboard
        )
        return BotState.MEDICAL_MTF_HRT
    elif choice == "–ó–∞–ø—Ä–æ—Å–∏—Ç—å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é –ø–æ –∂–µ–Ω—Å–∫–æ–π –ì–¢":
        keyboard = ReplyKeyboardMarkup([[BACK_BUTTON]], resize_keyboard=True)
        await update.message.reply_text(
            CONSULTATION_PROMPT,
            parse_mode="MarkdownV2",  # –ú–µ–Ω—è–µ–º –Ω–∞ MarkdownV2
            reply_markup=keyboard
        )
        context.user_data["request_type"] = REQUEST_TYPES["mtf_hrt"]
        return BotState.TYPING
    elif choice == "–Ø –ø–æ–Ω–∏–º–∞—é —Ä–∏—Å–∫–∏, —Å–∫–∞—á–∞—Ç—å –≥–∞–π–¥":
        return await send_hrt_guide(update, context, "mtf")
    await update.message.reply_text(
        escape_markdown("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –æ–ø—Ü–∏—é –∏–∑ –º–µ–Ω—é.", version=2),
        parse_mode="MarkdownV2"
    )
    return BotState.MEDICAL_MTF_HRT

async def send_hrt_guide(
    update: Update, context: ContextTypes.DEFAULT_TYPE, guide_type: str
) -> int:
    guide_path = os.getenv("DIY_HRT_GUIDE_PATH")
    if not guide_path:
        keyboard = ReplyKeyboardMarkup(
            [[f"–ó–∞–ø—Ä–æ—Å–∏—Ç—å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é –ø–æ {'–º—É–∂—Å–∫–æ–π' if guide_type == 'ftm' else '–∂–µ–Ω—Å–∫–æ–π'} –ì–¢"], [BACK_BUTTON]],
            resize_keyboard=True,
        )
        await update.message.reply_text(
            escape_markdown("–ü—É—Ç—å –∫ —Ñ–∞–π–ª—É –≥–∞–π–¥–∞ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω.", version=2),
            reply_markup=keyboard,
            parse_mode="MarkdownV2"
        )
        return BotState.MEDICAL_FTM_HRT if guide_type == "ftm" else BotState.MEDICAL_MTF_HRT
    try:
        with open(guide_path, "rb") as pdf_file:
            await context.bot.send_document(
                chat_id=update.effective_chat.id,
                document=pdf_file,
                filename="diyHRTguide.pdf",
            )
        keyboard = ReplyKeyboardMarkup(
            [[f"–ó–∞–ø—Ä–æ—Å–∏—Ç—å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é –ø–æ {'–º—É–∂—Å–∫–æ–π' if guide_type == 'ftm' else '–∂–µ–Ω—Å–∫–æ–π'} –ì–¢"], [BACK_BUTTON]],
            resize_keyboard=True,
        )
        return BotState.MEDICAL_FTM_HRT if guide_type == "ftm" else BotState.MEDICAL_MTF_HRT
    except FileNotFoundError:
        keyboard = ReplyKeyboardMarkup(
            [[f"–ó–∞–ø—Ä–æ—Å–∏—Ç—å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é –ø–æ {'–º—É–∂—Å–∫–æ–π' if guide_type == 'ftm' else '–∂–µ–Ω—Å–∫–æ–π'} –ì–¢"], [BACK_BUTTON]],
            resize_keyboard=True,
        )
        await update.message.reply_text(
            escape_markdown("–§–∞–π–ª –≥–∞–π–¥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω.", version=2),
            reply_markup=keyboard,
            parse_mode="MarkdownV2"
        )
        return BotState.MEDICAL_FTM_HRT if guide_type == "ftm" else BotState.MEDICAL_MTF_HRT
    except TelegramError as e:
        keyboard = ReplyKeyboardMarkup(
            [[f"–ó–∞–ø—Ä–æ—Å–∏—Ç—å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é –ø–æ {'–º—É–∂—Å–∫–æ–π' if guide_type == 'ftm' else '–∂–µ–Ω—Å–∫–æ–π'} –ì–¢"], [BACK_BUTTON]],
            resize_keyboard=True,
        )
        await update.message.reply_text(
            escape_markdown(f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–∞–π–ª–∞: {str(e)}", version=2),
            reply_markup=keyboard,
            parse_mode="MarkdownV2"
        )
        return BotState.MEDICAL_FTM_HRT if guide_type == "ftm" else BotState.MEDICAL_MTF_HRT

async def medical_surgery_planning(
    update: Update, context: ContextTypes.DEFAULT_TYPE
) -> int:
    if not await check_rate_limit(update, context):
        return BotState.MEDICAL_SURGERY_PLANNING
    choice = update.message.text
    keyboard = ReplyKeyboardMarkup([[BACK_BUTTON]], resize_keyboard=True)
    if choice == BACK_BUTTON:
        return await medical_menu(update, context)
    elif choice == "–§–¢–ú –û–ø–µ—Ä–∞—Ü–∏–∏":
        await update.message.reply_text(
            FTM_SURGERY_INFO,
            reply_markup=keyboard,
            parse_mode="MarkdownV2"
        )
        return BotState.MEDICAL_SURGERY_PLANNING
    elif choice == "–ú–¢–§ –û–ø–µ—Ä–∞—Ü–∏–∏":
        await update.message.reply_text(
            MTF_SURGERY_INFO,
            reply_markup=keyboard,
            parse_mode="MarkdownV2"
        )
        return BotState.MEDICAL_SURGERY_PLANNING
    await update.message.reply_text(
        escape_markdown("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –æ–ø—Ü–∏—é –∏–∑ –º–µ–Ω—é.", version=2),
        parse_mode="MarkdownV2"
    )
    return BotState.MEDICAL_SURGERY_PLANNING
